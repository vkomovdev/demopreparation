WITH CTE AS (
		SELECT
				[DP_REQUEST].REQUEST_ID,
				CONCAT([DP_REQUEST].LOT_YEAR, ' ', [DP_REQUEST].LOT_ID) AS LOT,
				CONCAT(Requestor.FIRST_NAME, ', ', Requestor.LAST_NAME) AS REQUESTOR,
				CONCAT(Receiver.FIRST_NAME, ', ', Receiver.LAST_NAME) AS RECEIVER,
				[DP_REQUEST].DATE_REQUEST,
				[DP_REQUEST].DATE_NEEDED,
				[DP_REQUEST].DIET_NAME,
				[DP_REQUEST].REQUEST_AMOUNT,
				[DP_REQUEST].REQUEST_UOM,
				[DP_REQUEST].LOCK,
				[DP_REQUEST].USEDASTEMPLATE,
				[DP_REQUEST].ISDELETED,
				COUNT(*) OVER () AS TotalItems
			FROM [DP_REQUEST]

			LEFT JOIN DP_CUSTOMER Requestor
				ON DP_REQUEST.REQUESTOR_ID = Requestor.CUSTOMER_ID 
			LEFT JOIN DP_CUSTOMER Receiver
				ON DP_REQUEST.DELIVER_TO_ID = Receiver.CUSTOMER_ID 
			WHERE 
				1 = 1
				@filter
				AND DP_REQUEST.LOT_YEAR >= (SELECT TOP 1 Value FROM DP_APP_SETUP)
		)
		SELECT
			REQUEST_ID,
			LOT,
			REQUESTOR,
			RECEIVER,
			DATE_REQUEST,
			DATE_NEEDED,
			DIET_NAME,
			REQUEST_AMOUNT,
			REQUEST_UOM,
			LOCK,
			USEDASTEMPLATE,
			ISDELETED,
			TotalItems	
		FROM CTE
		@orderBy
		OFFSET (@page - 1) * @pageSize ROWS
		FETCH NEXT @pageSize ROWS ONLY;